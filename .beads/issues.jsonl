{"id":"otherworlds-rpg-0b4","title":"Implement API route handlers","description":"Implement route handlers for each bounded context in otherworlds-api. Currently all domain routes return empty Router::new(). Each context needs command endpoints (POST) that accept JSON, dispatch to command handlers, and return results, plus query endpoints (GET) that read projections. Routes nest at /api/v1/{context} (e.g., /api/v1/narrative, /api/v1/characters). Requires AppState to have EventRepository wired in.","status":"closed","priority":1,"issue_type":"task","owner":"chris.bartling@gmail.com","created_at":"2026-02-27T22:24:08.398889-06:00","created_by":"Christopher Bartling","updated_at":"2026-02-28T00:00:00.000000-06:00","closed_at":"2026-02-28T00:00:00.000000-06:00","dependencies":[{"issue_id":"otherworlds-rpg-0b4","depends_on_id":"otherworlds-rpg-6mf","type":"blocks","created_at":"2026-02-27T22:24:13.441017-06:00","created_by":"Christopher Bartling"},{"issue_id":"otherworlds-rpg-0b4","depends_on_id":"otherworlds-rpg-4ln","type":"blocks","created_at":"2026-02-27T22:24:13.498771-06:00","created_by":"Christopher Bartling"}]}
{"id":"otherworlds-rpg-4ln","title":"Implement domain command handlers","description":"Implement command handlers for the 7 domain crates (narrative, rules, world-state, character, inventory, session, content). Each crate has an empty placeholder at src/application/command_handlers.rs. Handlers should accept Commands, validate them, produce DomainEvents, and persist via EventRepository. Follow the event-driven flow: Command -\u003e CommandHandler -\u003e DomainEvent(s) -\u003e EventRepository.append_events(). Use TDD — write failing tests first.","design":"## Narrative Exemplar First\n\nImplement otherworlds-narrative command handlers as the exemplar pattern, then replicate to remaining 6 crates in follow-up.\n\n### Architecture Decisions\n1. Function-based handlers: `async fn handle_*(cmd, \u0026dyn Clock, \u0026dyn EventRepository) -\u003e Result\u003cVec\u003cEvent\u003e, DomainError\u003e`\n2. Aggregate domain methods push events to `uncommitted_events`\n3. `apply()` stays minimal (version increment only)\n4. `apply_stored_event_version_only()` shortcut for reconstitution (full StoredEvent deserialization out of scope)\n5. Sequence number: `version + uncommitted_events.len() + 1`\n6. `causation_id` = `correlation_id` at command-to-event boundary\n\n### Files to Modify\n- `backend/crates/otherworlds-narrative/src/domain/aggregates.rs` — Add `advance_beat()`, `present_choice()` + tests\n- `backend/crates/otherworlds-narrative/src/application/command_handlers.rs` — Add handler fns + mock tests\n- `backend/crates/otherworlds-narrative/Cargo.toml` — Add tokio dev-dep\n\n### TDD Steps\n1. RED/GREEN: `advance_beat()` domain method on `NarrativeSession` → `BeatAdvanced` event\n2. RED/GREEN: `present_choice()` domain method → `ChoicePresented` event\n3. RED/GREEN: `handle_advance_beat()` async handler fn with MockEventRepository\n4. RED/GREEN: `handle_present_choice()` async handler fn\n5. Refactor: clippy, fmt, full test suite\n\n### Tests: 4 total (2 aggregate unit tests + 2 handler unit tests)","status":"closed","priority":1,"issue_type":"task","owner":"chris.bartling@gmail.com","created_at":"2026-02-27T22:24:02.067395-06:00","created_by":"Christopher Bartling","updated_at":"2026-02-27T22:59:53.772994-06:00","closed_at":"2026-02-27T22:59:53.772994-06:00","dependencies":[{"issue_id":"otherworlds-rpg-4ln","depends_on_id":"otherworlds-rpg-6mf","type":"blocks","created_at":"2026-02-27T22:24:13.379423-06:00","created_by":"Christopher Bartling"}]}
{"id":"otherworlds-rpg-6mf","title":"Wire PgEventRepository into AppState","description":"Add an Arc\u003cdyn EventRepository + Send + Sync\u003e field to AppState in otherworlds-api so route handlers can access the event store. Instantiate PgEventRepository from the PgPool during server startup in main.rs. Currently AppState holds PgPool, Clock, and Rng but the repository is not wired in.","status":"closed","priority":0,"issue_type":"task","owner":"chris.bartling@gmail.com","created_at":"2026-02-27T22:23:56.128387-06:00","created_by":"Christopher Bartling","updated_at":"2026-02-27T22:32:37.407789-06:00","closed_at":"2026-02-27T22:32:37.407791-06:00"}
